<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>周行程公示表</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* 原始品牌蓝色系 */
      --primary-900: #1E5F8E;
      --primary-700: #2D7AB8;
      --primary-600: #4A90D9;
      --primary-500: #6BA3E0;
      --primary-400: #8BB9E8;
      --primary-300: #A8D0F0;
      --primary-200: #C5E0F5;
      --primary-100: #E0EEFA;
      --primary-50: #F0F7FF;

      /* 状态色 */
      --local-color: #6B7280;
      --local-bg: #F3F4F6;
      --trip-color: #3B82F6;
      --trip-bg: #EFF6FF;
      --empty-color: #9CA3AF;

      /* 阴影 */
      --shadow-sm: 0 1px 2px rgba(30, 95, 142, 0.04), 0 1px 0 rgba(30, 95, 142, 0.02);
      --shadow-md: 0 4px 6px -1px rgba(30, 95, 142, 0.1), 0 2px 4px -1px rgba(30, 95, 142, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(30, 95, 142, 0.1), 0 4px 6px -2px rgba(30, 95, 142, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(30, 95, 142, 0.1), 0 8px 10px -6px rgba(30, 95, 142, 0.04);

      /* 过渡动画 */
      --transition-fast: 150ms ease;
      --transition-base: 200ms ease;
      --transition-slow: 300ms ease;
    }

    body {
      font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: var(--primary-50);
      color: var(--primary-900);
      font-size: 15px;
      line-height: 1.5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: var(--shadow-xl);
      overflow: hidden;
    }

    /* 顶部标题区 */
    .header {
      background: linear-gradient(135deg, #1E5F8E 0%, #2D7AB8 100%);
      color: #fff;
      padding: 24px 28px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-left h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
      letter-spacing: -0.5px;
    }

    .header-left .subtitle {
      font-size: 14px;
      opacity: 0.85;
      font-weight: 400;
    }

    .btn-export {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition-base);
      font-family: 'Open Sans', sans-serif;
    }

    .btn-export:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
    }

    /* Tab导航 */
    .tab-nav {
      display: flex;
      background: var(--primary-100);
      border-bottom: 1px solid var(--primary-200);
    }

    .tab-item {
      padding: 16px 28px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 15px;
      font-weight: 500;
      color: var(--primary-600);
      border-bottom: 2px solid transparent;
      transition: var(--transition-base);
      position: relative;
    }

    .tab-item:hover {
      color: var(--primary-900);
    }

    .tab-item.active {
      color: var(--primary-900);
      border-bottom-color: var(--primary-900);
      background: #fff;
    }

    .tab-item.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary-900);
    }

    /* Tab内容 */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* 工具栏 */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 24px;
      background: var(--primary-50);
      border-bottom: 1px solid var(--primary-200);
      flex-wrap: nowrap;
      overflow-x: auto;
    }

    .toolbar-left {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: nowrap;
    }

    .toolbar-right {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: nowrap;
      margin-left: auto;
    }

    .week-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .week-selector label {
      font-size: 14px;
      color: var(--primary-600);
      font-weight: 500;
    }

    .week-selector input[type="week"] {
      padding: 8px 12px;
      border: 1px solid var(--primary-300);
      border-radius: 8px;
      font-size: 14px;
      width: 170px;
      height: 38px;
      box-sizing: border-box;
      font-family: 'Open Sans', sans-serif;
      color: var(--primary-900);
      background: #fff;
      transition: var(--transition-base);
      cursor: pointer;
    }

    .week-selector input[type="week"]:focus {
      outline: none;
      border-color: var(--trip-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* 按钮 */
    .btn {
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: var(--transition-base);
      font-family: 'Open Sans', sans-serif;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary-900);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--primary-800);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: #fff;
      border: 1px solid var(--primary-300);
      color: var(--primary-700);
    }

    .btn-secondary:hover {
      background: var(--primary-50);
      border-color: var(--primary-400);
    }

    /* 图例 */
    .legend {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }

    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 4px;
    }

    .legend-dot.local {
      background: var(--local-color);
    }

    .legend-dot.trip {
      background: var(--trip-color);
    }

    .legend-dot.empty {
      background: var(--empty-color);
    }

    /* 表格容器 */
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0 24px 24px;
    }

    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }

    .schedule-table thead tr {
      background: var(--primary-900);
      color: #fff;
    }

    .schedule-table thead th {
      padding: 10px 16px;
      text-align: center;
      font-weight: 500;
      border-right: 1px solid rgba(255, 255, 255, 0.15);
      font-family: 'Poppins', sans-serif;
    }

    .schedule-table thead th:first-child {
      text-align: center;
      font-weight: 600;
    }

    .schedule-table thead th:last-child {
      border-right: none;
    }

    .header-weekday th {
      height: 38px;
    }

    .header-date th {
      height: 34px;
      font-size: 14px;
      background: #1E5F8E;
    }

    .schedule-table tbody tr {
      border-bottom: 1px solid var(--primary-200);
      transition: background-color var(--transition-fast);
    }

    .schedule-table tbody tr:last-child {
      border-bottom: none;
    }

    .schedule-table tbody tr:hover {
      background: var(--primary-50);
    }

    .schedule-table td {
      padding: 14px 16px;
      text-align: center;
      border-right: 1px solid var(--primary-200);
      min-width: 90px;
      transition: all var(--transition-fast);
    }

    .schedule-table td:last-child {
      border-right: none;
    }

    /* 固定列 */
    .region-cell,
    .person-name {
      text-align: center !important;
      position: sticky;
      background: #fff;
      z-index: 10;
      cursor: pointer;
    }

    .region-cell:hover,
    .person-name:hover {
      background: var(--primary-100) !important;
    }

    .region-cell {
      left: 0;
      min-width: 100px;
      color: #000000;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.03);
    }

    .person-name {
      left: 100px;
      min-width: 120px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      color: var(--primary-900);
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
    }

    .schedule-table tbody tr:hover .region-cell,
    .schedule-table tbody tr:hover .person-name {
      background: var(--primary-100);
    }

    /* 城市单元格样式 */
    .city-cell {
      cursor: pointer;
      transition: all var(--transition-base);
      position: relative;
    }

    .city-cell:hover {
      background: var(--primary-50) !important;
    }

    .city-cell.editing {
      outline: 2px solid var(--trip-color);
      outline-offset: -2px;
    }

    .city-local {
      color: #000000;
      font-weight: 600;
    }

    .city-trip {
      color: var(--trip-color);
      background: transparent;
      font-weight: 500;
    }

    .city-empty {
      color: var(--empty-color);
    }

    /* Toast 提示 */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--primary-900);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
      z-index: 2000;
      box-shadow: var(--shadow-lg);
    }

    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    /* 编辑输入框 */
    .city-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--trip-color);
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
      outline: none;
      font-family: 'Open Sans', sans-serif;
    }

    /* 城市选择弹窗 */
    .city-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .city-modal.show {
      display: flex;
    }

    .city-modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 28px;
      min-width: 360px;
      box-shadow: var(--shadow-2xl);
      max-width: 500px;
      width: 90%;
    }

    .city-modal-title {
      font-family: 'Poppins', sans-serif;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--primary-900);
    }

    .city-modal-section {
      margin-bottom: 20px;
    }

    .city-modal-section-title {
      font-size: 13px;
      color: var(--primary-500);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .city-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .city-option {
      padding: 10px 18px;
      border: 1px solid var(--primary-300);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      font-family: 'Open Sans', sans-serif;
      transition: var(--transition-base);
    }

    .city-option:hover {
      border-color: var(--trip-color);
      color: var(--trip-color);
      background: var(--trip-bg);
    }

    .city-option.local {
      background: var(--local-bg);
      color: var(--local-color);
    }

    .city-option.trip {
      background: var(--trip-bg);
      color: var(--trip-color);
      border-color: #BFDBFE;
    }

    .city-option.empty {
      color: var(--empty-color);
    }

    .city-modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--primary-200);
    }

    /* 文本编辑弹窗 */
    .text-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .text-modal.show {
      display: flex;
    }

    .text-modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 28px;
      min-width: 320px;
      box-shadow: var(--shadow-2xl);
    }

    .text-modal-title {
      font-family: 'Poppins', sans-serif;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--primary-900);
    }

    .text-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--primary-300);
      border-radius: 8px;
      font-size: 15px;
      font-family: 'Open Sans', sans-serif;
      color: var(--primary-900);
    }

    .text-input:focus {
      outline: none;
      border-color: var(--trip-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .text-modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    /* 响应式 */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      .header {
        padding: 20px;
      }

      .header-left h1 {
        font-size: 20px;
      }

      .toolbar {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }

      .toolbar-left {
        flex-direction: column;
        align-items: stretch;
      }

      .legend {
        gap: 16px;
      }

      .schedule-table thead th,
      .schedule-table td {
        padding: 12px 14px;
        min-width: 75px;
      }

      .region-cell {
        min-width: 85px;
        left: 0;
      }

      .person-name {
        min-width: 90px;
        left: 85px;
      }

      .city-modal-content {
        margin: 20px;
        padding: 20px;
      }
    }

    /* 导出图片时的样式 */
    .exporting #tabNav {
      display: none !important;
    }

    .exporting .header {
      background: linear-gradient(135deg, #1E5F8E 0%, #2D7AB8 100%) !important;
    }

    .exporting .header h1,
    .exporting .header .subtitle {
      color: #fff !important;
    }

    .exporting .toolbar {
      background: #fff !important;
    }

    .exporting .week-selector label,
    .exporting .legend-item {
      color: var(--primary-700) !important;
    }

    .exporting .btn-export,
    .exporting .btn,
    .exporting .btn-icon,
    .exporting .btn-manage,
    .exporting .import-export-buttons,
    .exporting .history-buttons,
    .exporting .save-status,
    .exporting .edit-hint {
      display: none !important;
    }

    /* 固定列 */
    .exporting .region-cell,
    .exporting .person-name {
      position: static !important;
    }

    /* 编辑提示 */
    .edit-hint {
      display: none;
      background: #FEF3C7;
      border-bottom: 1px solid #FCD34D;
      padding: 12px 24px;
      font-size: 14px;
      color: #92400E;
      align-items: center;
      gap: 8px;
    }

    .edit-hint.show {
      display: flex;
    }

    /* 保存状态指示器 */
    .save-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--primary-600);
      padding: 6px 12px;
      background: var(--primary-100);
      border-radius: 6px;
      font-weight: 500;
      white-space: nowrap;
    }

    .save-status.saving {
      color: #D97706;
      background: #FEF3C7;
    }

    .save-status.saved {
      color: #059669;
      background: #D1FAE5;
    }

    .save-status-icon {
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }

    .save-status.saved .save-status-icon {
      animation: none;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* 撤销/重做按钮 */
    .history-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      padding: 8px 12px;
      border: 1px solid var(--primary-300);
      background: #fff;
      color: var(--primary-600);
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .btn-icon:hover:not(:disabled) {
      background: var(--primary-50);
      border-color: var(--primary-400);
    }

    .btn-icon:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-icon svg {
      width: 16px;
      height: 16px;
    }

    /* 选中单元格样式 */
    .city-cell.selected {
      outline: 2px solid var(--trip-color);
      outline-offset: -2px;
      background: var(--trip-bg) !important;
    }

    /* 右键菜单 */
    .context-menu {
      display: none;
      position: fixed;
      background: #fff;
      border: 1px solid var(--primary-200);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      z-index: 2000;
      min-width: 160px;
      padding: 8px 0;
    }

    .context-menu.show {
      display: block;
    }

    .context-menu-item {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      color: var(--primary-900);
      transition: var(--transition-fast);
    }

    .context-menu-item:hover {
      background: var(--primary-50);
    }

    .context-menu-divider {
      height: 1px;
      background: var(--primary-200);
      margin: 8px 0;
    }

    /* 人员管理按钮 */
    .btn-manage {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: 1px solid var(--primary-300);
      background: #fff;
      color: var(--primary-600);
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition-base);
      font-size: 14px;
      font-weight: 500;
    }

    .btn-manage:hover {
      background: var(--primary-50);
      border-color: var(--primary-400);
    }

    /* 人员管理弹窗 */
    .personnel-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .personnel-modal.show {
      display: flex;
    }

    .personnel-modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 28px;
      min-width: 500px;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
    }

    .personnel-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--primary-200);
    }

    .personnel-modal-title {
      font-family: 'Poppins', sans-serif;
      font-size: 20px;
      font-weight: 600;
      color: var(--primary-900);
    }

    .personnel-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .personnel-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--primary-50);
      border-radius: 8px;
      transition: var(--transition-base);
    }

    .personnel-item:hover {
      background: var(--primary-100);
    }

    .personnel-item.dragging {
      opacity: 0.5;
      background: var(--primary-200);
    }

    .personnel-item-handle {
      cursor: grab;
      color: var(--primary-400);
    }

    .personnel-item-handle:active {
      cursor: grabbing;
    }

    .personnel-item-info {
      flex: 1;
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .personnel-item-input {
      padding: 8px 12px;
      border: 1px solid var(--primary-300);
      border-radius: 6px;
      font-size: 14px;
      font-family: 'Open Sans', sans-serif;
    }

    .personnel-item-input.region {
      width: 100px;
    }

    .personnel-item-input.name {
      width: 120px;
    }

    .personnel-item-input.city {
      width: 100px;
    }

    .personnel-item-actions {
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 6px;
    }

    .btn-add-person {
      margin-top: 16px;
      width: 100%;
    }

    .import-export-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* 快捷键提示 */
    .keyboard-hint {
      font-size: 12px;
      color: var(--primary-500);
      margin-top: 8px;
      text-align: center;
    }

    .kbd {
      display: inline-block;
      padding: 2px 6px;
      background: var(--primary-100);
      border: 1px solid var(--primary-300);
      border-radius: 4px;
      font-family: monospace;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="container" id="scheduleContainer">
    <div class="header">
      <div class="header-left">
        <h1 id="pageTitle">自营业务部周行程公示表</h1>
        <div class="subtitle" id="weekTitle">加载中...</div>
      </div>
      <button class="btn-export" onclick="exportToImage()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        导出图片
      </button>
    </div>

    <!-- Tab导航 -->
    <div class="tab-nav" id="tabNav">
      <div class="tab-item active" data-tab="self-operated" onclick="switchTab('self-operated')">自营业务部</div>
      <div class="tab-item" data-tab="investment" onclick="switchTab('investment')">招商业务部</div>
    </div>

    <!-- 编辑提示 -->
    <div class="edit-hint" id="editHint">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0;">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path>
        <path d="M9 11l6 6"></path>
        <line x1="12" y1="17" x2="12" y2="9"></line>
      </svg>
      <span>点击单元格可编辑行程，编辑完成后点击"保存"按钮</span>
    </div>

    <!-- 自营业务部 -->
    <div class="tab-content active" id="tab-self-operated">
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="week-selector">
            <label>选择周：</label>
            <input type="week" id="weekInputSelf" onchange="updateWeekDisplay()">
          </div>
          <div class="legend">
            <div class="legend-item">
              <span class="legend-dot local"></span>本市
            </div>
            <div class="legend-item">
              <span class="legend-dot trip"></span>出差
            </div>
            <div class="legend-item">
              <span class="legend-dot empty"></span>休息
            </div>
          </div>
        </div>
        <div class="toolbar-right">
          <button class="btn btn-secondary" onclick="resetData('self-operated')">重置</button>
          <div class="history-buttons">
        <button class="btn-icon" id="btnUndoSelf" onclick="undo()" title="撤销 (Ctrl+Z)" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 14 4 9l5-5"/>
            <path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/>
          </svg>
        </button>
        <button class="btn-icon" id="btnRedoSelf" onclick="redo()" title="重做 (Ctrl+Y)" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 14l5-5-5-5"/>
            <path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13"/>
          </svg>
        </button>
      </div>
      <div class="import-export-buttons">
        <button class="btn btn-secondary" onclick="downloadTemplate()">下载模板</button>
        <button class="btn btn-secondary" onclick="exportToExcel('self-operated')">导出Excel</button>
        <button class="btn btn-secondary" onclick="document.getElementById('importInputSelf').click()">导入</button>
        <input type="file" id="importInputSelf" accept=".xlsx,.xls,.csv" style="display:none" onchange="importFromExcel(event, 'self-operated')">
        <button class="btn-manage" onclick="openPersonnelModal('self-operated')">人员管理</button>
      </div>
      <div class="save-status" id="saveStatusSelf">
        <svg class="save-status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <span id="saveStatusTextSelf">已保存</span>
      </div>
        </div>
      </div>

      <div class="table-wrapper">
        <table class="schedule-table" id="tableSelfOperated">
          <thead>
            <tr class="header-weekday">
              <th rowspan="2">区域</th>
              <th rowspan="2">姓名</th>
              <th>周一</th>
              <th>周二</th>
              <th>周三</th>
              <th>周四</th>
              <th>周五</th>
              <th>周六</th>
              <th>周日</th>
            </tr>
            <tr class="header-date">
              <th id="dateSelf_0"></th>
              <th id="dateSelf_1"></th>
              <th id="dateSelf_2"></th>
              <th id="dateSelf_3"></th>
              <th id="dateSelf_4"></th>
              <th id="dateSelf_5"></th>
              <th id="dateSelf_6"></th>
            </tr>
          </thead>
          <tbody id="tbodySelfOperated"></tbody>
        </table>
      </div>
    </div>

    <!-- 招商业务部 -->
    <div class="tab-content" id="tab-investment">
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="week-selector">
            <label>选择周：</label>
            <input type="week" id="weekInputInvestment" onchange="updateWeekDisplay()">
          </div>
          <div class="legend">
            <div class="legend-item">
              <span class="legend-dot local"></span>本市
            </div>
            <div class="legend-item">
              <span class="legend-dot trip"></span>出差
            </div>
            <div class="legend-item">
              <span class="legend-dot empty"></span>休息
            </div>
          </div>
        </div>
        <div class="toolbar-right">
          <button class="btn btn-secondary" onclick="resetData('investment')">重置</button>
          <div class="history-buttons">
        <button class="btn-icon" id="btnUndoInv" onclick="undo()" title="撤销 (Ctrl+Z)" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 14 4 9l5-5"/>
            <path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/>
          </svg>
        </button>
        <button class="btn-icon" id="btnRedoInv" onclick="redo()" title="重做 (Ctrl+Y)" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 14l5-5-5-5"/>
            <path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13"/>
          </svg>
        </button>
      </div>
      <div class="import-export-buttons">
        <button class="btn btn-secondary" onclick="downloadTemplate()">下载模板</button>
        <button class="btn btn-secondary" onclick="exportToExcel('investment')">导出Excel</button>
        <button class="btn btn-secondary" onclick="document.getElementById('importInputInv').click()">导入</button>
        <input type="file" id="importInputInv" accept=".xlsx,.xls,.csv" style="display:none" onchange="importFromExcel(event, 'investment')">
        <button class="btn-manage" onclick="openPersonnelModal('investment')">人员管理</button>
      </div>
      <div class="save-status" id="saveStatusInv">
        <svg class="save-status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <span id="saveStatusTextInv">已保存</span>
      </div>
        </div>
      </div>

      <div class="table-wrapper">
        <table class="schedule-table" id="tableInvestment">
          <thead>
            <tr class="header-weekday">
              <th rowspan="2">区域</th>
              <th rowspan="2">姓名</th>
              <th>周一</th>
              <th>周二</th>
              <th>周三</th>
              <th>周四</th>
              <th>周五</th>
              <th>周六</th>
              <th>周日</th>
            </tr>
            <tr class="header-date">
              <th id="dateInv_0"></th>
              <th id="dateInv_1"></th>
              <th id="dateInv_2"></th>
              <th id="dateInv_3"></th>
              <th id="dateInv_4"></th>
              <th id="dateInv_5"></th>
              <th id="dateInv_6"></th>
            </tr>
          </thead>
          <tbody id="tbodyInvestment"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 城市选择弹窗 -->
  <div class="city-modal" id="cityModal">
    <div class="city-modal-content">
      <div class="city-modal-title" id="modalTitle">选择行程状态</div>

      <div class="city-modal-section">
        <div class="city-modal-section-title">本市</div>
        <div class="city-options" id="localCityOptions"></div>
      </div>

      <div class="city-modal-section">
        <div class="city-modal-section-title">出差外埠</div>
        <div class="city-options">
          <div class="city-option trip" onclick="selectCity('杭州')">杭州</div>
          <div class="city-option trip" onclick="selectCity('南京')">南京</div>
          <div class="city-option trip" onclick="selectCity('苏州')">苏州</div>
          <div class="city-option trip" onclick="selectCity('成都')">成都</div>
          <div class="city-option trip" onclick="selectCity('重庆')">重庆</div>
          <div class="city-option trip" onclick="selectCity('武汉')">武汉</div>
          <div class="city-option trip" onclick="selectCity('西安')">西安</div>
          <div class="city-option trip" onclick="selectCity('天津')">天津</div>
          <div class="city-option trip" onclick="selectCity('长沙')">长沙</div>
          <div class="city-option trip" onclick="selectCity('郑州')">郑州</div>
          <div class="city-option trip" onclick="selectCity('青岛')">青岛</div>
          <div class="city-option trip" onclick="selectCity('大连')">大连</div>
          <div class="city-option trip" onclick="selectCity('沈阳')">沈阳</div>
          <div class="city-option trip" onclick="selectCity('济南')">济南</div>
          <div class="city-option trip" onclick="selectCity('合肥')">合肥</div>
          <div class="city-option trip" onclick="selectCity('南昌')">南昌</div>
          <div class="city-option trip" onclick="selectCity('福州')">福州</div>
          <div class="city-option trip" onclick="selectCity('厦门')">厦门</div>
          <div class="city-option trip" onclick="selectCity('南宁')">南宁</div>
          <div class="city-option trip" onclick="selectCity('昆明')">昆明</div>
          <div class="city-option trip" onclick="selectCity('贵阳')">贵阳</div>
        </div>
      </div>

      <div class="city-modal-section" id="customCitySection">
        <div class="city-modal-section-title">自定义城市</div>
        <div class="city-input-wrapper" style="display: flex; gap: 8px;">
          <input type="text" id="customCityInput" class="city-input" placeholder="输入城市名称" style="flex: 1;" onkeypress="if(event.key==='Enter')confirmCustomCity()">
          <button class="btn btn-primary" onclick="confirmCustomCity()" style="padding: 8px 16px;">确定</button>
        </div>
      </div>

      <div class="city-modal-section">
        <div class="city-modal-section-title">其他</div>
        <div class="city-options">
          <div class="city-option empty" onclick="selectCity('-')">休息日</div>
        </div>
      </div>

      <div class="city-modal-actions">
        <button class="btn btn-secondary" onclick="closeCityModal()">取消</button>
      </div>
    </div>
  </div>

  <!-- 文本编辑弹窗 -->
  <div class="text-modal" id="textModal">
    <div class="text-modal-content">
      <div class="text-modal-title" id="textModalTitle">编辑</div>
      <div class="city-modal-section">
        <input type="text" id="textInput" class="text-input" placeholder="请输入内容">
      </div>
      <div class="text-modal-actions">
        <button class="btn btn-secondary" onclick="closeTextModal()">取消</button>
        <button class="btn btn-primary" onclick="confirmTextEdit()">确定</button>
      </div>
    </div>
  </div>

  <!-- 右键菜单 -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="batchSetCity()">设置为...</div>
    <div class="context-menu-item" onclick="batchSetRest()">设为休息日</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="batchSetLocal()">设为常驻城市</div>
    <div class="context-menu-item" onclick="clearSelection()">取消选择</div>
  </div>

  <!-- 人员管理弹窗 -->
  <div class="personnel-modal" id="personnelModal">
    <div class="personnel-modal-content">
      <div class="personnel-modal-header">
        <div class="personnel-modal-title">人员管理</div>
        <button class="btn-icon" onclick="closePersonnelModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="personnel-list" id="personnelList"></div>
      <button class="btn btn-secondary btn-add-person" onclick="addNewPersonnel()">
        + 添加人员
      </button>
      <div class="keyboard-hint">
        提示：拖拽 <span class="kbd">⋮⋮</span> 可调整人员顺序
      </div>
      <div class="text-modal-actions" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--primary-200);">
        <button class="btn btn-secondary" onclick="closePersonnelModal()">取消</button>
        <button class="btn btn-primary" onclick="savePersonnelChanges()">保存更改</button>
      </div>
    </div>
  </div>

  <!-- html2canvas库 -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- SheetJS 用于Excel导入导出 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    'use strict';

    // ========== 数据定义 ==========
    const nameCityMap = {
      '乔鹏飞': '上海', '李俊杰': '北京', '李芳芳': '太原', '王丽东': '沈阳',
      '王洪志': '南京', '陈克伟': '石家庄', '高鹿鹿': '广州', '张炜': '上海',
      '张利香': '郑州', '李辉华': '杭州', '李振兴': '潍坊', '顾陈霞': '无锡',
      '朱琼红': '广州', '潘贵彩': '黔南', '沈忱': '深圳', '刘新': '合肥',
      '邵珠峰': '济南', '吴非': '沈阳', '钱毅': '西安', '杨跃进': '济南', '刘宁': '太原'
    };

    const initialData = {
      selfOperated: [
        { region: '总部', name: '乔鹏飞', schedule: ['上海', '上海', '上海', '上海', '上海', '-', '-'] },
        { region: '北京', name: '李俊杰', schedule: ['北京', '北京', '北京', '北京', '北京', '-', '-'] },
        { region: '山西', name: '李芳芳', schedule: ['太原', '太原', '太原', '太原', '太原', '-', '-'] },
        { region: '东北', name: '王丽东', schedule: ['沈阳', '沈阳', '沈阳', '沈阳', '沈阳', '-', '-'] },
        { region: '江苏', name: '王洪志', schedule: ['南京', '南京', '南京', '南京', '南京', '-', '-'] },
        { region: '华北', name: '陈克伟', schedule: ['石家庄', '石家庄', '石家庄', '石家庄', '石家庄', '-', '-'] },
        { region: '华南', name: '高鹿鹿', schedule: ['广州', '广州', '广州', '广州', '广州', '-', '-'] },
        { region: '上海', name: '张炜', schedule: ['上海', '上海', '上海', '上海', '上海', '-', '-'] },
        { region: '华中', name: '张利香', schedule: ['郑州', '郑州', '郑州', '郑州', '郑州', '-', '-'] },
        { region: '浙江', name: '李辉华', schedule: ['杭州', '杭州', '杭州', '杭州', '杭州', '-', '-'] }
      ],
      investment: [
        { region: '总部', name: '李振兴', schedule: ['潍坊', '潍坊', '潍坊', '潍坊', '潍坊', '-', '-'] },
        { region: '苏', name: '顾陈霞', schedule: ['无锡', '无锡', '无锡', '无锡', '无锡', '-', '-'] },
        { region: '粤琼', name: '朱琼红', schedule: ['广州', '广州', '广州', '广州', '广州', '-', '-'] },
        { region: '西南', name: '潘贵彩', schedule: ['黔南', '黔南', '黔南', '黔南', '黔南', '-', '-'] },
        { region: '华南', name: '沈忱', schedule: ['深圳', '深圳', '深圳', '深圳', '深圳', '-', '-'] },
        { region: '华东', name: '刘新', schedule: ['合肥', '合肥', '合肥', '合肥', '合肥', '-', '-'] },
        { region: '京津冀', name: '邵珠峰', schedule: ['济南', '济南', '济南', '济南', '济南', '-', '-'] },
        { region: '东北', name: '吴非', schedule: ['沈阳', '沈阳', '沈阳', '沈阳', '沈阳', '-', '-'] },
        { region: '西北', name: '钱毅', schedule: ['西安', '西安', '西安', '西安', '西安', '-', '-'] },
        { region: '鲁', name: '杨跃进', schedule: ['济南', '济南', '济南', '济南', '济南', '-', '-'] },
        { region: '豫晋蒙', name: '刘宁', schedule: ['太原', '太原', '太原', '太原', '太原', '-', '-'] }
      ]
    };

    const tabTitles = {
      'self-operated': '自营业务部周行程公示表',
      'investment': '招商业务部周行程公示表'
    };

    // ========== 全局状态 ==========
    let currentData = {
      selfOperated: JSON.parse(localStorage.getItem('schedule_selfOperated')) || JSON.parse(JSON.stringify(initialData.selfOperated)),
      investment: JSON.parse(localStorage.getItem('schedule_investment')) || JSON.parse(JSON.stringify(initialData.investment))
    };
    let currentTab = 'self-operated';
    let editingCell = null;
    let editingType = null;

    // 撤销/重做历史
    const historyStack = { selfOperated: [], investment: [] };
    const redoStack = { selfOperated: [], investment: [] };
    const MAX_HISTORY = 50;

    // 批量选择
    let selectedCells = [];
    let lastClickedCell = null;

    // 自动保存防抖
    let autoSaveTimer = null;
    let isDirty = { selfOperated: false, investment: false };

    // 人员管理临时数据
    let personnelTempData = [];

    // ========== 工具函数 ==========
    const getDataKey = tab => tab === 'self-operated' ? 'selfOperated' : 'investment';
    const getTabSuffix = tab => tab === 'self-operated' ? 'Self' : 'Inv';

    function showToast(message, duration = 2000) {
      let toast = document.querySelector('.toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.className = 'toast';
        document.body.appendChild(toast);
      }
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    function getWeekNumber(date) {
      const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
      const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
      return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    }

    // ========== 历史记录管理 ==========
    function saveHistory(tab) {
      const dataKey = getDataKey(tab);
      const state = JSON.stringify(currentData[dataKey]);
      if (historyStack[dataKey].length > 0 && historyStack[dataKey][historyStack[dataKey].length - 1] === state) {
        return;
      }
      historyStack[dataKey].push(state);
      redoStack[dataKey] = [];
      if (historyStack[dataKey].length > MAX_HISTORY) {
        historyStack[dataKey].shift();
      }
      updateHistoryButtons(tab);
    }

    function updateHistoryButtons(tab) {
      const dataKey = getDataKey(tab);
      const suffix = getTabSuffix(tab);
      const btnUndo = document.getElementById(`btnUndo${suffix}`);
      const btnRedo = document.getElementById(`btnRedo${suffix}`);
      if (btnUndo) btnUndo.disabled = historyStack[dataKey].length === 0;
      if (btnRedo) btnRedo.disabled = redoStack[dataKey].length === 0;
    }

    function undo() {
      const dataKey = getDataKey(currentTab);
      if (historyStack[dataKey].length === 0) return;
      redoStack[dataKey].push(JSON.stringify(currentData[dataKey]));
      currentData[dataKey] = JSON.parse(historyStack[dataKey].pop());
      initTable(currentTab);
      updateHistoryButtons(currentTab);
      markDirty(currentTab);
      scheduleAutoSave(currentTab);
      showToast('已撤销');
    }

    function redo() {
      const dataKey = getDataKey(currentTab);
      if (redoStack[dataKey].length === 0) return;
      historyStack[dataKey].push(JSON.stringify(currentData[dataKey]));
      currentData[dataKey] = JSON.parse(redoStack[dataKey].pop());
      initTable(currentTab);
      updateHistoryButtons(currentTab);
      markDirty(currentTab);
      scheduleAutoSave(currentTab);
      showToast('已重做');
    }

    // ========== 保存状态管理 ==========
    function markDirty(tab) {
      isDirty[getDataKey(tab)] = true;
    }

    function updateSaveStatus(tab, status) {
      const suffix = getTabSuffix(tab);
      const statusEl = document.getElementById(`saveStatus${suffix}`);
      const textEl = document.getElementById(`saveStatusText${suffix}`);
      if (!statusEl || !textEl) return;
      statusEl.className = 'save-status';
      if (status === 'saving') {
        statusEl.classList.add('saving');
        textEl.textContent = '保存中...';
      } else if (status === 'saved') {
        statusEl.classList.add('saved');
        textEl.textContent = '已保存';
        isDirty[getDataKey(tab)] = false;
      } else {
        textEl.textContent = '有未保存更改';
      }
    }

    function performSave(tab) {
      const dataKey = getDataKey(tab);
      try {
        localStorage.setItem(`schedule_${tab}`, JSON.stringify(currentData[dataKey]));
        updateSaveStatus(tab, 'saved');
      } catch (e) {
        showToast('保存失败：存储空间不足');
      }
    }

    function scheduleAutoSave(tab) {
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
      updateSaveStatus(tab, 'unsaved');
      autoSaveTimer = setTimeout(() => {
        updateSaveStatus(tab, 'saving');
        setTimeout(() => performSave(tab), 300);
      }, 2000);
    }

    function saveData(tab) {
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
      performSave(tab);
      showToast('保存成功！');
    }

    // ========== 表格渲染 ==========
    function initTable(tab) {
      const tbody = document.getElementById(tab === 'self-operated' ? 'tbodySelfOperated' : 'tbodyInvestment');
      const data = currentData[getDataKey(tab)];
      tbody.innerHTML = '';

      data.forEach((person, rowIndex) => {
        const tr = document.createElement('tr');

        const regionTd = document.createElement('td');
        regionTd.className = 'region-cell';
        regionTd.textContent = person.region;
        regionTd.onclick = () => openTextModal(tab, rowIndex, 'region', person.region);
        tr.appendChild(regionTd);

        const nameTd = document.createElement('td');
        nameTd.className = 'person-name';
        nameTd.textContent = person.name;
        nameTd.onclick = () => openTextModal(tab, rowIndex, 'name', person.name);
        tr.appendChild(nameTd);

        person.schedule.forEach((city, colIndex) => {
          const td = document.createElement('td');
          td.className = 'city-cell';
          td.dataset.row = rowIndex;
          td.dataset.col = colIndex;
          td.dataset.tab = tab;

          if (city === '-') {
            td.innerHTML = '<span class="city-empty">-</span>';
          } else if (city === nameCityMap[person.name]) {
            td.innerHTML = `<span class="city-local">${city}</span>`;
          } else {
            td.innerHTML = `<span class="city-trip">${city}</span>`;
          }

          td.onclick = (e) => handleCellClick(e, td, tab, rowIndex, colIndex);
          td.oncontextmenu = (e) => handleCellRightClick(e, tab, rowIndex, colIndex);

          if (selectedCells.some(c => c.row === rowIndex && c.col === colIndex && c.tab === tab)) {
            td.classList.add('selected');
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }

    // ========== 批量选择 ==========
    function handleCellClick(e, cell, tab, row, col) {
      if (e.shiftKey && lastClickedCell) {
        e.preventDefault();
        selectRange(lastClickedCell, { tab, row, col });
        initTable(tab);
      } else if (e.ctrlKey || e.metaKey) {
        // Ctrl+点击：多选
        if (selectedCells.some(c => c.row === row && c.col === col && c.tab === tab)) {
          selectedCells = selectedCells.filter(c => !(c.row === row && c.col === col && c.tab === tab));
        } else {
          selectedCells.push({ tab, row, col });
        }
        lastClickedCell = { tab, row, col };
        initTable(tab);
      } else {
        // 普通点击：打开编辑弹窗
        selectedCells = [];
        lastClickedCell = null;
        openCityModal(cell, tab, row, col);
      }
    }

    function selectRange(start, end) {
      const minRow = Math.min(start.row, end.row);
      const maxRow = Math.max(start.row, end.row);
      const minCol = Math.min(start.col, end.col);
      const maxCol = Math.max(start.col, end.col);

      for (let r = minRow; r <= maxRow; r++) {
        for (let c = minCol; c <= maxCol; c++) {
          if (!selectedCells.some(cell => cell.row === r && cell.col === c && cell.tab === start.tab)) {
            selectedCells.push({ tab: start.tab, row: r, col: c });
          }
        }
      }
    }

    function clearSelection() {
      selectedCells = [];
      lastClickedCell = null;
      initTable(currentTab);
      hideContextMenu();
    }

    function handleCellRightClick(e, tab, row, col) {
      e.preventDefault();
      if (!selectedCells.some(c => c.row === row && c.col === col && c.tab === tab)) {
        selectedCells = [{ tab, row, col }];
        lastClickedCell = { tab, row, col };
        initTable(tab);
      }
      showContextMenu(e.clientX, e.clientY);
    }

    // ========== 右键菜单 ==========
    function showContextMenu(x, y) {
      const menu = document.getElementById('contextMenu');
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.classList.add('show');
    }

    function hideContextMenu() {
      document.getElementById('contextMenu').classList.remove('show');
    }

    function batchSetCity() {
      hideContextMenu();
      const city = prompt('请输入要设置的城市：');
      if (!city) return;
      applyToSelected(cell => {
        const dataKey = getDataKey(cell.tab);
        currentData[dataKey][cell.row].schedule[cell.col] = city;
      });
    }

    function batchSetRest() {
      hideContextMenu();
      applyToSelected(cell => {
        const dataKey = getDataKey(cell.tab);
        currentData[dataKey][cell.row].schedule[cell.col] = '-';
      });
    }

    function batchSetLocal() {
      hideContextMenu();
      applyToSelected(cell => {
        const dataKey = getDataKey(cell.tab);
        const person = currentData[dataKey][cell.row];
        currentData[dataKey][cell.row].schedule[cell.col] = nameCityMap[person.name] || person.schedule[cell.col];
      });
    }

    function applyToSelected(fn) {
      if (selectedCells.length === 0) return;
      saveHistory(currentTab);
      selectedCells.forEach(fn);
      selectedCells = [];
      initTable(currentTab);
      markDirty(currentTab);
      scheduleAutoSave(currentTab);
      showToast('已更新');
    }

    // ========== 弹窗管理 ==========
    function openCityModal(cell, tab, row, col) {
      editingCell = { cell, tab, row, col };
      editingType = 'city';
      document.getElementById('modalTitle').textContent = '选择行程状态';
      document.getElementById('customCityInput').value = '';
      document.getElementById('customCitySection').style.display = 'block';

      const dataKey = getDataKey(tab);
      const person = currentData[dataKey][row];
      const localCity = nameCityMap[person.name];

      const localCities = {
        'self-operated': ['上海', '北京', '太原', '沈阳', '南京', '石家庄', '广州', '郑州', '杭州'],
        'investment': ['潍坊', '无锡', '广州', '黔南', '深圳', '合肥', '济南', '沈阳', '西安', '太原']
      };

      const currentTabCities = localCities[tab] || [];
      let localOptionsHTML = '';
      currentTabCities.forEach(city => {
        const isCurrentPersonLocal = city === localCity;
        localOptionsHTML += `<div class="city-option ${isCurrentPersonLocal ? 'local' : ''}" onclick="selectCity('${city}')">${city}</div>`;
      });

      document.getElementById('localCityOptions').innerHTML = localOptionsHTML;
      document.getElementById('cityModal').classList.add('show');
    }

    function closeCityModal() {
      document.getElementById('cityModal').classList.remove('show');
      editingCell = null;
      editingType = null;
    }

    function confirmCustomCity() {
      const input = document.getElementById('customCityInput');
      const city = input.value.trim();
      if (city) selectCity(city);
    }

    function selectCity(city) {
      if (!editingCell) return;
      const { cell, tab, row, col } = editingCell;

      saveHistory(tab);
      const dataKey = getDataKey(tab);
      currentData[dataKey][row].schedule[col] = city;

      if (city === '-') {
        cell.innerHTML = '<span class="city-empty">-</span>';
      } else if (city === nameCityMap[currentData[dataKey][row].name]) {
        cell.innerHTML = `<span class="city-local">${city}</span>`;
      } else {
        cell.innerHTML = `<span class="city-trip">${city}</span>`;
      }

      markDirty(tab);
      scheduleAutoSave(tab);
      closeCityModal();
    }

    function openTextModal(tab, row, type, currentValue) {
      editingCell = { tab, row, type };
      editingType = type;
      const titles = { 'region': '编辑区域', 'name': '编辑姓名' };
      document.getElementById('textModalTitle').textContent = titles[type];
      document.getElementById('textInput').value = currentValue;
      document.getElementById('textModal').classList.add('show');
      document.getElementById('textInput').focus();
      document.getElementById('textInput').select();
    }

    function closeTextModal() {
      document.getElementById('textModal').classList.remove('show');
      editingCell = null;
      editingType = null;
    }

    function confirmTextEdit() {
      if (!editingCell) return;
      const { tab, row, type } = editingCell;
      const value = document.getElementById('textInput').value.trim();
      if (!value) {
        alert('内容不能为空');
        return;
      }

      saveHistory(tab);
      const dataKey = getDataKey(tab);

      if (type === 'region') {
        currentData[dataKey][row].region = value;
      } else if (type === 'name') {
        const oldName = currentData[dataKey][row].name;
        currentData[dataKey][row].name = value;
        if (nameCityMap[oldName]) {
          nameCityMap[value] = nameCityMap[oldName];
          delete nameCityMap[oldName];
        }
      }

      initTable(tab);
      markDirty(tab);
      scheduleAutoSave(tab);
      closeTextModal();
    }

    // ========== 粘贴功能 ==========
    function pasteRow(event, tab, rowIndex) {
      event.stopPropagation();
      const dataKey = getDataKey(tab);
      const person = currentData[dataKey][rowIndex];

      navigator.clipboard.readText().then(clipText => {
        if (!clipText.trim()) {
          showToast('剪贴板为空');
          return;
        }

        let cities = clipText.replace(/[,，、]/g, ' ').trim().split(/\s+/).filter(c => c.length > 0);

        if (cities.length !== 7) {
          const colonIndex = clipText.indexOf('：');
          if (colonIndex !== -1) {
            const afterColon = clipText.substring(colonIndex + 1);
            cities = afterColon.replace(/[,，、]/g, ' ').trim().split(/\s+/).filter(c => c.length > 0);
          }
        }

        if (cities.length === 7) {
          saveHistory(tab);
          currentData[dataKey][rowIndex].schedule = cities;
          initTable(tab);
              markDirty(tab);
          scheduleAutoSave(tab);
          showToast(`${person.name}的行程已更新`);
        } else {
          showToast('格式错误：需要7个城市（用空格分隔）');
        }
      }).catch(() => {
        const input = prompt('请输入7天的行程（用空格分隔）：\n例如：上海 北京 深圳 广州 杭州 - -');
        if (input) {
          let cities = input.replace(/[,，、]/g, ' ').trim().split(/\s+/).filter(c => c.length > 0);
          if (cities.length === 7) {
            saveHistory(tab);
            currentData[dataKey][rowIndex].schedule = cities;
            initTable(tab);
                  markDirty(tab);
            scheduleAutoSave(tab);
            showToast(`${person.name}的行程已更新`);
          } else {
            showToast('格式错误：需要7个城市（用空格分隔）');
          }
        }
      });
    }

    // ========== Excel导入导出 ==========
    function downloadTemplate() {
      const wb = XLSX.utils.book_new();
      const wsData = [
        ['区域', '姓名', '周一', '周二', '周三', '周四', '周五', '周六', '周日'],
        ['总部', '张三', '上海', '上海', '上海', '上海', '上海', '-', '-'],
        ['北京', '李四', '北京', '北京', '北京', '北京', '北京', '-', '-'],
        ['说明', '', '', '', '', '', '', '', ''],
        ['', '', '1. 修改「区域」和「姓名」列填写人员信息'],
        ['', '', '2. 周一到周日填写行程，休息日用「-」表示'],
        ['', '', '3. 填写完成后，点击「导入」按钮上传此文件']
      ];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      // 设置列宽
      ws['!cols'] = [
        { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 },
        { wch: 10 }, { wch: 10 }, { wch: 8 }, { wch: 8 }
      ];
      XLSX.utils.book_append_sheet(wb, ws, '行程模板');
      XLSX.writeFile(wb, '行程表导入模板.xlsx');
      showToast('模板已下载');
    }

    function exportToExcel(tab) {
      const dataKey = getDataKey(tab);
      const data = currentData[dataKey];

      const wb = XLSX.utils.book_new();
      const wsData = [['区域', '姓名', '周一', '周二', '周三', '周四', '周五', '周六', '周日']];

      data.forEach(person => {
        wsData.push([person.region, person.name, ...person.schedule]);
      });

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, '行程表');
      XLSX.writeFile(wb, `${tabTitles[tab]}_${new Date().toISOString().slice(0, 10)}.xlsx`);
      showToast('Excel导出成功');
    }

    function importFromExcel(event, tab) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          if (jsonData.length < 2) {
            showToast('文件格式错误');
            return;
          }

          saveHistory(tab);
          const dataKey = getDataKey(tab);
          const newData = [];

          for (let i = 1; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row.length < 2) continue;
            const schedule = [];
            for (let j = 2; j < 9; j++) {
              schedule.push(row[j] || '-');
            }
            newData.push({
              region: String(row[0] || ''),
              name: String(row[1] || ''),
              schedule: schedule
            });
          }

          if (newData.length > 0) {
            currentData[dataKey] = newData;
            initTable(tab);
                  markDirty(tab);
            scheduleAutoSave(tab);
            showToast('导入成功');
          }
        } catch (err) {
          showToast('导入失败：' + err.message);
        }
        event.target.value = '';
      };
      reader.readAsArrayBuffer(file);
    }

    // ========== 人员管理 ==========
    function openPersonnelModal(tab) {
      currentTab = tab;
      const dataKey = getDataKey(tab);
      personnelTempData = JSON.parse(JSON.stringify(currentData[dataKey]));
      renderPersonnelList();
      document.getElementById('personnelModal').classList.add('show');
    }

    function closePersonnelModal() {
      document.getElementById('personnelModal').classList.remove('show');
      personnelTempData = [];
    }

    function renderPersonnelList() {
      const list = document.getElementById('personnelList');
      list.innerHTML = '';

      personnelTempData.forEach((person, index) => {
        const item = document.createElement('div');
        item.className = 'personnel-item';
        item.draggable = true;
        item.dataset.index = index;
        item.innerHTML = `
          <div class="personnel-item-handle" onmousedown="startDrag(event, ${index})">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <circle cx="9" cy="6" r="1.5"/><circle cx="15" cy="6" r="1.5"/>
              <circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/>
              <circle cx="9" cy="18" r="1.5"/><circle cx="15" cy="18" r="1.5"/>
            </svg>
          </div>
          <div class="personnel-item-info">
            <input type="text" class="personnel-item-input region" value="${person.region}" data-index="${index}" data-field="region">
            <input type="text" class="personnel-item-input name" value="${person.name}" data-index="${index}" data-field="name">
            <input type="text" class="personnel-item-input city" value="${nameCityMap[person.name] || ''}" data-index="${index}" data-field="city" placeholder="常驻城市">
          </div>
          <div class="personnel-item-actions">
            <button class="btn btn-sm btn-secondary" onclick="movePersonnel(${index}, -1)" ${index === 0 ? 'disabled' : ''}>↑</button>
            <button class="btn btn-sm btn-secondary" onclick="movePersonnel(${index}, 1)" ${index === personnelTempData.length - 1 ? 'disabled' : ''}>↓</button>
            <button class="btn btn-sm btn-secondary" onclick="deletePersonnel(${index})" ${personnelTempData.length <= 1 ? 'disabled' : ''}>删除</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    let dragIndex = null;

    function startDrag(e, index) {
      dragIndex = index;
      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', endDrag);
    }

    function onDrag(e) {
      if (dragIndex === null) return;
      const items = document.querySelectorAll('.personnel-item');
      items.forEach(item => item.classList.remove('dragging'));
      const target = e.target.closest('.personnel-item');
      if (target) target.classList.add('dragging');
    }

    function endDrag(e) {
      if (dragIndex === null) return;
      const target = e.target.closest('.personnel-item');
      if (target && target.dataset.index !== undefined) {
        const targetIndex = parseInt(target.dataset.index);
        if (targetIndex !== dragIndex) {
          const [removed] = personnelTempData.splice(dragIndex, 1);
          personnelTempData.splice(targetIndex, 0, removed);
          renderPersonnelList();
        }
      }
      dragIndex = null;
      document.removeEventListener('mousemove', onDrag);
      document.removeEventListener('mouseup', endDrag);
    }

    function movePersonnel(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= personnelTempData.length) return;
      [personnelTempData[index], personnelTempData[newIndex]] = [personnelTempData[newIndex], personnelTempData[index]];
      renderPersonnelList();
    }

    function deletePersonnel(index) {
      if (confirm('确定要删除此人员吗？')) {
        personnelTempData.splice(index, 1);
        renderPersonnelList();
      }
    }

    function addNewPersonnel() {
      personnelTempData.push({ region: '新区域', name: '新人员', schedule: ['-', '-', '-', '-', '-', '-', '-'] });
      renderPersonnelList();
    }

    function savePersonnelChanges() {
      saveHistory(currentTab);

      const inputs = document.querySelectorAll('.personnel-item-input');
      inputs.forEach(input => {
        const index = parseInt(input.dataset.index);
        const field = input.dataset.field;
        if (field === 'city') {
          const value = input.value.trim();
          if (value) nameCityMap[personnelTempData[index].name] = value;
        } else {
          personnelTempData[index][field] = input.value.trim();
        }
      });

      const dataKey = getDataKey(currentTab);
      currentData[dataKey] = personnelTempData;
      initTable(currentTab);
      markDirty(currentTab);
      scheduleAutoSave(currentTab);
      closePersonnelModal();
      showToast('人员信息已更新');
    }

    // ========== Tab切换 ==========
    function switchTab(tabName) {
      currentTab = tabName;
      document.getElementById('pageTitle').textContent = tabTitles[tabName];
      document.querySelectorAll('.tab-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.tab === tabName) item.classList.add('active');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');
      selectedCells = [];
      updateHistoryButtons(tabName);
    }

    // ========== 周显示更新 ==========
    function updateWeekDisplay() {
      const weekInput1 = document.getElementById('weekInputSelf');
      const weekInput2 = document.getElementById('weekInputInvestment');

      if (!weekInput1.value) {
        const now = new Date();
        const year = now.getFullYear();
        const week = getWeekNumber(now);
        const weekValue = `${year}-W${String(week).padStart(2, '0')}`;
        weekInput1.value = weekValue;
        weekInput2.value = weekValue;
      } else {
        weekInput2.value = weekInput1.value;
      }

      const weekValue = weekInput1.value;
      const [year, week] = weekValue.split('-W').map(Number);

      const firstDay = new Date(year, 0, 1 + (week - 1) * 7);
      const dayOfWeek = firstDay.getDay();
      const monday = new Date(firstDay);
      monday.setDate(firstDay.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

      const month = monday.getMonth() + 1;
      const day = monday.getDate();
      const endDay = new Date(monday);
      endDay.setDate(monday.getDate() + 6);
      const endMonth = endDay.getMonth() + 1;
      const endDayNum = endDay.getDate();

      document.getElementById('weekTitle').textContent = `${year}年第${String(week).padStart(2, '0')}周 · ${month}/${day} - ${endMonth}/${endDayNum}`;

      const dates = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        dates.push(`${d.getMonth() + 1}/${d.getDate()}`);
      }

      for (let i = 0; i < 7; i++) {
        const th = document.getElementById(`dateSelf_${i}`);
        if (th) th.textContent = dates[i];
        const th2 = document.getElementById(`dateInv_${i}`);
        if (th2) th2.textContent = dates[i];
      }
    }

    // ========== 重置数据 ==========
    function resetData(tab) {
      if (confirm('确定要重置为初始数据吗？所有修改将丢失！')) {
        const dataKey = getDataKey(tab);
        currentData[dataKey] = JSON.parse(JSON.stringify(initialData[dataKey]));
        localStorage.removeItem(`schedule_${tab}`);
        historyStack[dataKey] = [];
        redoStack[dataKey] = [];
        initTable(tab);
          updateHistoryButtons(tab);
        updateSaveStatus(tab, 'saved');
        showToast('数据已重置');
      }
    }

    // ========== 导出图片 ==========
    async function exportToImage() {
      const activeTab = document.querySelector('.tab-content.active');
      const table = activeTab.querySelector('.schedule-table');
      const tableWrapper = activeTab.querySelector('.table-wrapper');
      const fullWidth = tableWrapper.scrollWidth;

      const weekText = document.getElementById('weekTitle').textContent;
      const title = tabTitles[currentTab];

      const exportContainer = document.createElement('div');
      exportContainer.style.position = 'absolute';
      exportContainer.style.left = '0';
      exportContainer.style.top = '-99999px';
      exportContainer.style.width = 'auto';
      exportContainer.style.background = '#fff';
      exportContainer.style.fontFamily = "'Open Sans', -apple-system, sans-serif";

      exportContainer.innerHTML = `
        <div style="background: linear-gradient(135deg, #1E5F8E 0%, #2D7AB8 100%); color: #fff; padding: 32px 36px;">
          <h1 style="font-family: 'Poppins', sans-serif; font-size: 42px; font-weight: 600; margin: 0 0 10px 0;">${title}</h1>
          <div style="font-size: 26px; opacity: 0.85;">${weekText}</div>
        </div>
        <div id="exportTableWrapper"></div>
        <div style="padding: 16px 36px 24px; display: flex; gap: 48px; align-items: center; font-size: 26px; color: #374151;">
          <span style="font-weight: 600;">备注：</span>
          <span style="display: flex; align-items: center; gap: 8px;">
            <span style="width: 18px; height: 18px; background: #64748B; border-radius: 4px;"></span>本市
          </span>
          <span style="display: flex; align-items: center; gap: 8px;">
            <span style="width: 18px; height: 18px; background: #2563EB; border-radius: 4px;"></span>出差
          </span>
          <span style="display: flex; align-items: center; gap: 8px;">
            <span style="width: 18px; height: 18px; background: #94A3B8; border-radius: 4px;"></span>休息
          </span>
        </div>
      `;

      document.body.appendChild(exportContainer);

      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      const fixedTableWidth = fullWidth * 2;
      let tableHTML = '<table style="width: ' + fixedTableWidth + 'px; table-layout: fixed; border-collapse: collapse; font-size: 32px; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">';

      tableHTML += '<thead style="background: #1E5F8E; color: #fff;">';
      const headerRows = thead.querySelectorAll('tr');
      headerRows.forEach((row, index) => {
        tableHTML += '<tr>';
        const ths = row.querySelectorAll('th');
        ths.forEach((th, i) => {
          const rowspan = th.getAttribute('rowspan') || '';
          tableHTML += `<th style="padding: 10px 16px; text-align: center; font-weight: 500; border-right: 1px solid rgba(255,255,255,0.15);" ${rowspan ? 'rowspan="' + rowspan + '"' : ''}>${th.textContent}</th>`;
        });
        tableHTML += '</tr>';
      });
      tableHTML += '</thead><tbody>';
      const trs = tbody.querySelectorAll('tr');
      trs.forEach((tr, rowIndex) => {
        tableHTML += '<tr style="border-bottom: 1px solid #C5E0F5;">';
        const tds = tr.querySelectorAll('td');
        tds.forEach((td, i) => {
          let cellStyle = 'padding: 22px 24px; text-align: center; border-right: 1px solid #C5E0F5;';
          let cellContent = td.textContent;
          if (td.querySelector('.city-empty')) {
            cellContent = '<span style="color: #94A3B8;">-</span>';
          } else if (td.querySelector('.city-local')) {
            cellContent = `<span style="color: #000000; font-weight: 600;">${cellContent}</span>`;
          } else if (td.querySelector('.city-trip')) {
            cellContent = `<span style="color: #2563EB;">${cellContent}</span>`;
          } else if (td.classList.contains('region-cell') || td.classList.contains('person-name')) {
            cellStyle = 'padding: 22px 24px; text-align: center; border-right: 1px solid #E5E7EB; color: #000000; font-weight: 600;';
          }
          tableHTML += `<td style="${cellStyle}">${cellContent}</td>`;
        });
        tableHTML += '</tr>';
      });
      tableHTML += '</tbody></table>';

      document.getElementById('exportTableWrapper').innerHTML = tableHTML;
      await new Promise(resolve => setTimeout(resolve, 200));

      // 获取实际渲染后的宽度
      const actualWidth = exportContainer.scrollWidth;

      try {
        const canvas = await html2canvas(exportContainer, {
          scale: 4,
          backgroundColor: '#fff',
          width: actualWidth,
          useCORS: true,
          allowTaint: true,
          logging: false
        });

        document.body.removeChild(exportContainer);
        const link = document.createElement('a');
        link.download = `${tabTitles[currentTab]}_${new Date().toISOString().slice(0, 10)}.png`;
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
      } catch (error) {
        console.error('导出失败:', error);
        if (exportContainer.parentNode) document.body.removeChild(exportContainer);
        alert('导出失败：' + error.message);
      }
    }

    // ========== 快捷键支持 ==========
    document.addEventListener('keydown', function(e) {
      // 检查是否在输入框中
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        if (e.key === 'Escape') {
          e.target.blur();
          closeCityModal();
          closeTextModal();
        }
        return;
      }

      // Ctrl/Cmd + S: 保存
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveData(currentTab);
        return;
      }

      // Ctrl/Cmd + Z: 撤销
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
        return;
      }

      // Ctrl/Cmd + Y 或 Ctrl+Shift+Z: 重做
      if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
        e.preventDefault();
        redo();
        return;
      }

      // Esc: 关闭弹窗、取消选择
      if (e.key === 'Escape') {
        closeCityModal();
        closeTextModal();
        closePersonnelModal();
        hideContextMenu();
        if (selectedCells.length > 0) {
          clearSelection();
        }
        return;
      }

      // Delete: 删除选中单元格内容
      if (e.key === 'Delete' && selectedCells.length > 0) {
        batchSetRest();
        return;
      }
    });

    // 点击其他地方关闭右键菜单
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.context-menu')) {
        hideContextMenu();
      }
    });

    // ========== 初始化 ==========
    function init() {
      initTable('self-operated');
      initTable('investment');
      updateWeekDisplay();
      updateHistoryButtons('self-operated');
      updateHistoryButtons('investment');
    }

    init();
  </script>
</body>
</html>